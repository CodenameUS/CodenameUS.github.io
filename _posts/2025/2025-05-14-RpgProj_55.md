---
layer: single
title: "유니티 RPG - 55. 장착장비저장 및 프로젝트 완성"
categories: Unity
tag: [C#, Unity, project]
toc: true
author_profile: false
sidebar: 
    nav: "docs"
---


# Intro

이번포스팅은 플레이어의 장착중인 장비데이터를 저장하고 불러오는것을 끝으로 이 프로젝트를 마무리지으려합니다.

장착중인 장비데이터의 저장이 필요한 이유는, 

만약 플레이어가 장비를 장착한체 게임을 종료하게되면 아이템을 장착하여 얻은 능력치가 함께 저장되지만 다시 게임을 실행하면 장착중인 아이템은 없이 능력치만 늘어나게 되기때문입니다.

- EquipmentUI : 플레이어가 현재 장착중인 장비데이터를 JSON 파일에 저장하고 불러오는 기능 추가


## EquipmentUI.cs

Inventory 클래스와 마찬가지로 Data 클래스나 DTO 클래스를 따로 작성하지않고, 

EquimentUI 클래스에 포함시켰습니다.

슬롯마다의 Data를 저장하기위해 <b>itemDataArray</b> 변수가 추가적으로 필요했고

Load와 Save를 위한 메서드가 필요했습니다.

```c#
[System.Serializable]
public class EquipmentSlotData
{
    public int slotIndex;              
    public int itemId;
}

[System.Serializable]
public class EquipmentSlotDataList
{
    public List<EquipmentSlotData> itemList;
}

public class EquipmentUI : MonoBehaviour
{
    public ItemData[] itemDataArray;


    #endregion  

    #region ** 유니티 이벤트 함수 **
    private void Awake()
    {
        Init();
    }

    private void Start()
    {
        LoadEquipmentSlotData();
        HideUI();
    }
    #endregion

    #region ** Private Methods **

    // 초기화
    private void Init()
    {
        // ...
        itemDataArray = new ItemData[slotCounts];
    }

    // 플레이어가 장착중인 아이템 데이터 로드
    private void LoadEquipmentSlotData()
    {
        string path = Path.Combine(Application.persistentDataPath, "EquipmentSlotData.json");

        if (File.Exists(path))
        {
            string jsonData = File.ReadAllText(path);
            EquipmentSlotDataList dataList = JsonUtility.FromJson<EquipmentSlotDataList>(jsonData);

            foreach (var data in dataList.itemList)
            {
                itemDataArray[data.slotIndex] = ItemTypeById(data.itemId);

                // 해당 슬롯인덱스에 저장된 아이템이 없을 때
                if (itemDataArray[data.slotIndex] == null)
                {
                    continue;
                }

                // 슬롯에 아이템 추가
                Item item = itemDataArray[data.slotIndex].CreateItem();

                if(item is WeaponItem wi)
                {
                    SetItemIcon(wi, wi.WeaponData.Type, wi.Data.ItemIcon);
                }
                else if(item is ArmorItem ai)
                {
                    SetItemIcon(ai, ai.ArmorData.SubType, ai.Data.ItemIcon);
                }
            }
        }

        // 아이템 타입별 반환
        ItemData ItemTypeById(int id)
        { 
            if (id > 20000 && id < 30000)
            {
                ArmorItemData temp = DataManager.Instance.GetArmorDataById(id);
                return temp;
            }
            else if (id > 30000 && id < 40000)
            {
                WeaponItemData temp = DataManager.Instance.GetWeaponDataById(id);
                return temp;
            }
            else
                return null;
        }
    }

    // 장작중인 아이템 데이터 저장
    private void SaveEquipmentSlotData()
    {
        EquipmentSlotDataList saveData = new EquipmentSlotDataList();
        saveData.itemList = new List<EquipmentSlotData>();

        for(int i = 0;i<items.Length;i++)
        {
            EquipmentSlotData slotData = new EquipmentSlotData();
            slotData.slotIndex = i;

            if(items[i] != null)
            {
                slotData.itemId = items[i].Data.ID;
            }
            else
            {
                slotData.itemId = 0;
            }

            saveData.itemList.Add(slotData);
        }

        string jsonData = JsonUtility.ToJson(saveData, true);
        string path = Path.Combine(Application.persistentDataPath, "EquipmentSlotData.json");
        File.WriteAllText(path, jsonData);

        Debug.Log("장착 장비 저장완료");
    }
    // 아이템 아이콘
    public void SetItemIcon(Item item, string type, string icon)
    {
        // 아이템 타입에 따른 index
        if (Enum.TryParse(type, out Type result))
        {
            int index = (int)result;

            // 슬롯 아이템 저장
            items[index] = item;

            // 아이콘 등록
            slotUIList[index].SetItemIcon(icon);
        }
        else
        {
            Debug.LogError($"'{type}'은(는) 유효한 타입이 아닙니다.");
        }

        SaveEquipmentSlotData();
    }
}
```

장착 아이템 데이터를 저장하는것은 단순히 장비슬롯의 인덱스와, 그 슬롯의 장비아이템 ID만 있으면됩니다.

왜냐하면 장비착용과 해제에따른 이벤트는 Inventory 클래스가 담당하고있기때문입니다.

따라서 저장해야하는 데이터는 SlotIndex와 ItemID입니다.

* 저장
    - 4개의 장비 슬롯을 순회하면서 그 슬롯의 인덱스와 아이템ID를 저장합니다.

* 로드
    - JSON 파일을 읽어서 슬롯Index에 저장된 아이템 데이터가 있다면 Id의 아이템 객체를 생성하고 SetItemIcon()를 호출합니다.
    - SetItemIcon() 메서드에서는 item을 저장하고, 아이콘을 등록합니다.



